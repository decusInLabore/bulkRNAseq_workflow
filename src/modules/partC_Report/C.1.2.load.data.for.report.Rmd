## R-Data loading option for custom plotting

```{r create db user, echo=F, eval=T, warning=FALSE}
FN <- paste0(hpc.mount, "Projects/reference_data/pwd_folder/babs.txt")
dbTable <- read.delim(
  FN,
  header = F,
  sep = "\t",
  stringsAsFactors = F
)

db.pwd <- as.vector(dbTable[1,1])
#setwd(Obio@parameterList$workdir)

doQuery <- function(
    Obio, 
    query,
    resOut = FALSE
){
    library(RMySQL)
    res <- NULL
    dbDB <- dbConnect(
        drv = RMySQL::MySQL(), 
        user = Obio@dbDetailList$db.user, 
        password = db.pwd, 
        host = Obio@dbDetailList$host,
        dbname = Obio@dbDetailList$primDataDB
    ) 
    tryCatch(res <- dbGetQuery(dbDB, query), error = function(c) {
        c$message <- stop(paste0("Error in ", query, "."))
    })
    dbDisconnect(dbDB)
    if (resOut){
        return(res)
    }
}


## Check if project access file exists ##
projectAccessDir <- paste0(Obio@parameterList$workdir, "project_access/")
projectAccessFile <- paste0(Obio@parameterList$workdir, "project_access/project_access.txt")

if (file.exists(projectAccessFile)){
    df <- read.delim(
        projectAccessFile, 
        sep = "\t",
        stringsAsFactors = F
    )
    username <- df$username
    pass <- df$pass
    
} else {
    username <- paste0(Obio@parameterList$project_id,"_da")
    sPwd <-c(2:9,letters,LETTERS)
    pass <- paste(sample(sPwd,8),collapse="")
    df <- data.frame(username, pass)
    if (!dir.exists(projectAccessDir)){
        dir.create(projectAccessDir, recursive = T)
    }
    write.table(df, projectAccessFile, row.names=F, sep="\t")
    
    ## Create user in db
    query0 <- paste0("SELECT User, Host FROM mysql.user WHERE User = '",username,"' AND Host = '10.%';")
    res <- doQuery(Obio, query = query0, resOut=TRUE)
    if (nrow(res) > 0){
        query0a <- paste0("DROP USER '",username,"'@'10.%';")   
        doQuery(Obio, query = query0a)
    }
    
    query1 <- paste0(
        "CREATE USER '",
        username, 
        "'@'10.%' IDENTIFIED BY '",
        pass,
        "';"
    )
    
    doQuery(Obio, query = query1)
    # mysql -h 10.27.241.82 -u boeingS -p
    # 5+3f4nB04042018
}




## Assign project tables ##

## Design
designTB <- Obio@parameterList$designdbTableName
query2 <- paste0("GRANT SELECT on ",Obio@dbDetailList$primDataDB,".",designTB ," TO ",username,"@'10.%';")

doQuery(Obio, query = query2)
## Main
mainTB <- Obio@parameterList$rnaseqdbTableName
query3 <- paste0("GRANT SELECT on ",Obio@dbDetailList$primDataDB,".",mainTB ," TO ",username,"@'10.%';")
doQuery(Obio, query = query3)

## PCA
pcaTB <- Obio@parameterList$PCAdbTableName
query4 <- paste0("GRANT SELECT on ",Obio@dbDetailList$primDataDB,".",pcaTB ," TO ",username,"@'10.%';")
doQuery(Obio, query = query4)

host <- Obio@dbDetailList$host
db <- Obio@dbDetailList$primDataDB

designString <- designTB
mainTBstring <- mainTB
pcaDbTable <- pcaTB

## Done installing package                                                   ##
###############################################################################


userString <- paste0('username <- "', username,'"')
passString <- paste0('pass <- "', pass,'"')
hostString <- paste0('host <- "', host,'"')
dbString <- paste0('db <- "', db,'"')

designString <- paste0('designTB <- "', designTB,'"')
mainTBstring <- paste0('mainTB <- "', mainTB,'"')
pcaDbTable <- paste0('pcaTB <- "', pcaTB,'"')

species <- Obio@parameterList$species
geneIDcolumn <- Obio@parameterList$geneIDcolumn
alignmentGeneID <- Obio@parameterList$primaryAlignmentGeneID

speciesString <- paste0('species <- "', species,'"')
alignmentGeneIDString <- paste0('alignmentGeneID <- "', alignmentGeneID,'"')
geneIDstring <- paste0('geneIDcolumn <- "', geneIDcolumn,'"')


pos <- grep("designTScol", names(Obio@parameterList))
if (length(pos) > 0){
    if (!is.null(Obio@parameterList$designTScol)){
        designTScol <- Obio@parameterList$designTScol
        timepointString <- paste0('designTScol <- "', designTScol,'"')
    }
} else {
    timepointString <- ""   
}




```

<style>
    div.grey pre { background-color:#f5f5f5; }
    div.grey pre.r { background-color:black; }
</style>
            
Here we set the database access variables so we can get your data in </br></br>
            
<div class = "grey">
```{r dbparameters1, echo=F, eval=T, warning=FALSE,comment=NA}
            
            oneString <- paste0(
                userString,
                "\n",
                passString,
                "\n",
                hostString,
                "\n",
                dbString,
                "\n"
            )
            
            cat(oneString)
            
            
```
</div>
                
Here we define the tables from which we draw the data:
<div class = "grey">
```{r dbparameters2, echo=F, eval=T, warning=FALSE,comment=NA}
            
            twoString <- paste0(
                designString,
                "\n",
                mainTBstring,
                "\n",
                pcaDbTable,
                "\n"
            )
            
            cat(twoString)
            
            
```
 </div>
                
                
And here we set a few more variables we'll need for plotting:
<div class = "grey">
```{r dbparameters3, echo=F, eval=T, warning=FALSE,comment=NA}

threeString <- paste0(
    speciesString,
    "\n",
    geneIDstring,
    "\n",
    alignmentGeneIDString,
    "\n",
    timepointString
)

cat(threeString)


```
</div>

## Loading relevant data into your R-session

Next, let's load your project data. We will need this as a basis for making the plots further down. 

```{r load_data2, echo=TRUE, eval=F, warning=FALSE}

#if (length(grep("bioLOGIC", as.vector(installed.packages()[,"Package"]))) ==0 ){
    devtools::install_github("decusinlabore/bioLOGIC")
#}

library(bioLOGIC)

## Load the design table from database. Here we will retrieve information on samples. 
dfDesign <- import.db.table.from.db(
    dbname = db,
    dbtable = designTB,
    host = host,
    user = username,
    password = pass
)


## Load main data table from database. In this table a lot of gene-level information for this project is assembled. 

dfMainData <- import.db.table.from.db(
    dbname = db,
    dbtable = mainTB,
    host = host,
    user = username,
    password = pass
)

## Load main pca table from database. This table contains cell-level PCA information.
dfPCA <- import.db.table.from.db(
    dbname = db,
    dbtable = pcaTB,
    host = host,
    user = username,
    password = pass
)

## For some plots we want to limit the number of genes to the most interesting, so let's get those in a vector:

# Most variable gene names
dfVar <- dfMainData[dfMainData$logFC_cut_off != 0 ,c(geneIDcolumn, alignmentGeneID)]
mostVarGenes <- as.vector(unique(sort(dfVar[,geneIDcolumn])))
mostVarGenes <- na.omit(mostVarGenes[mostVarGenes != ""])
# Most variable gene IDs
mostVarIDs <- as.vector(unique(sort(dfVar[,alignmentGeneID])))
mostVarIDs <- na.omit(mostVarIDs[mostVarIDs != ""])

```


```{r load_report_data, echo=F, eval=T, warning=FALSE,comment=NA}

## In this section the data for this report is loaded from file in order to maintain version control. The data loaded in this section should be identical with the version of the proejct kept in the database. 

dfDesign <- Obio@dfDesign
dfMainData <- Obio@databaseTable
dfPCA <- Obio@dfPCA
dfModel <- Obio@dfModel

dfVar <- dfMainData[dfMainData$logFC_cut_off != 0 ,c(geneIDcolumn, alignmentGeneID)]
mostVarGenes <- as.vector(unique(sort(dfVar[,geneIDcolumn])))
mostVarGenes <- na.omit(mostVarGenes[mostVarGenes != ""])
# Most variable gene IDs
mostVarIDs <- as.vector(unique(sort(dfVar[,alignmentGeneID])))
mostVarIDs <- na.omit(mostVarIDs[mostVarIDs != ""])

```